@startuml EC2U PhD Agreements Tool Flow
!theme plain

participant "Client" as client
participant "Server" as server
participant "Key-Value Store" as store
participant "Async Worker" as worker
participant "Langfuse" as langfuse
participant "Gemini" as gemini

client -> server: launch task
activate server
server -> store: initialize task status
server -> worker: delegate task
activate worker
server --> client: task id
deactivate server

par
    group loop [task execution]
        worker -> langfuse: retrieve prompt
        activate langfuse
        langfuse --> worker: prompt
        deactivate langfuse
        worker -> gemini: execute prompt
        activate gemini
        gemini --> worker: response
        deactivate gemini
        worker -> store: update task status
    end
    worker -> worker: assemble task results
    worker -> store: store task results
    deactivate worker
else
    group loop [polling]
        client -> server: check status
        activate server
        server -> store: retrieve task status
        store --> server: task status
        server --> client: task status
        deactivate server
    end

end
activate server
server -> store: retrieve task results
store --> server: task results
server -> store: clear task status
server --> client: task results

@enduml
